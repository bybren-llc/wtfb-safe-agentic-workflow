# RLS Migration Pattern

## What It Does

Creates a Prisma database migration with Row Level Security (RLS) policies to protect user data. Ensures users can only access their own data at the database level.

## When to Use

- Adding new tables with user data
- Adding columns containing sensitive data
- Creating tables for user-specific content
- Any schema change involving `user_id`

## Code Pattern

### Step 1: Create Prisma Schema

```prisma
// prisma/schema.prisma

model user_preferences {
  id            Int      @id @default(autoincrement())
  user_id       String   @db.VarChar(255)
  theme         String?  @db.VarChar(50)
  notifications Boolean  @default(true)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Foreign key relationship
  user user @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  @@index([user_id], name: "user_preferences_user_id_idx")
  @@map("user_preferences")
}
```

### Step 2: Create Migration

```bash
# Generate migration
npx prisma migrate dev --name add_user_preferences_with_rls

# This creates: prisma/migrations/YYYYMMDDHHMMSS_add_user_preferences_with_rls/migration.sql
```

### Step 3: Add RLS Policies to Migration

```sql
-- prisma/migrations/YYYYMMDDHHMMSS_add_user_preferences_with_rls/migration.sql

-- 1. Create table (auto-generated by Prisma)
CREATE TABLE "user_preferences" (
    "id" SERIAL NOT NULL,
    "user_id" VARCHAR(255) NOT NULL,
    "theme" VARCHAR(50),
    "notifications" BOOLEAN NOT NULL DEFAULT true,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "user_preferences_pkey" PRIMARY KEY ("id")
);

-- 2. Create index for RLS performance
CREATE INDEX "user_preferences_user_id_idx" ON "user_preferences"("user_id");

-- 3. Add foreign key constraint
ALTER TABLE "user_preferences" ADD CONSTRAINT "user_preferences_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "user"("user_id") ON DELETE CASCADE ON UPDATE CASCADE;

-- =====================================================
-- RLS POLICIES (MANDATORY FOR USER DATA TABLES)
-- =====================================================

-- 4. Enable RLS on the table
ALTER TABLE "user_preferences" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "user_preferences" FORCE ROW LEVEL SECURITY;

-- 5. Create RLS policy for superuser (wtfb_user)
-- Allows operations where user_id matches current session user
CREATE POLICY user_preferences_isolation ON "user_preferences"
    FOR ALL
    TO wtfb_user
    USING (user_id = current_setting('app.current_user_id', true));

-- 6. Create RLS policy for application user (wtfb_app_user)
-- Enforces same isolation for application-level access
CREATE POLICY user_preferences_app_isolation ON "user_preferences"
    FOR ALL
    TO wtfb_app_user
    USING (user_id = current_setting('app.current_user_id', true));

-- =====================================================
-- ADMIN ACCESS (OPTIONAL)
-- =====================================================

-- 7. Create admin policy (allows admins to access all data)
CREATE POLICY user_preferences_admin_access ON "user_preferences"
    FOR ALL
    TO wtfb_user
    USING (
        current_setting('app.current_role', true) = 'admin'
    );

-- Note: Admin context sets app.current_role = 'admin'
-- This allows admins to bypass user isolation when using withAdminContext()
```

### Step 4: Test Migration Locally

```bash
# Run migration on local database
DATABASE_URL="postgresql://wtfb_user:wtfb_password@localhost:5432/wtfb_dev" \
npx prisma migrate dev --name add_user_preferences_with_rls

# Verify RLS policies were created
docker exec -it wtfb-postgres psql -U wtfb_user -d wtfb_dev \
  -c "\d user_preferences"

# Check RLS is enabled
docker exec -it wtfb-postgres psql -U wtfb_user -d wtfb_dev \
  -c "SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = 'user_preferences';"
```

### Step 5: Update Documentation

```markdown
## Update DATA_DICTIONARY.md

Add new table documentation:

### `user_preferences`

**Purpose**: Store user-specific UI and notification preferences

**RLS**: ✅ Enabled (user isolation)

| Column        | Type         | Purpose                     | Constraints                  |
| ------------- | ------------ | --------------------------- | ---------------------------- |
| id            | SERIAL       | Primary key                 | NOT NULL, AUTO INCREMENT     |
| user_id       | VARCHAR(255) | User owner                  | NOT NULL, FK to user.user_id |
| theme         | VARCHAR(50)  | UI theme preference         | NULL                         |
| notifications | BOOLEAN      | Email notifications enabled | DEFAULT true                 |
| created_at    | TIMESTAMP    | Creation time               | DEFAULT now()                |
| updated_at    | TIMESTAMP    | Last update                 | AUTO UPDATE                  |

**Indexes**:

- `user_preferences_user_id_idx` on `user_id` (for RLS performance)

**Recent Changes**:

- 2025-10-03: Created table with RLS policies [WOR-300]
```

## RLS Policy Patterns

### User Isolation (Standard)

```sql
-- Users can only access their own data
CREATE POLICY {table}_isolation ON {table}
    FOR ALL
    TO wtfb_user
    USING (user_id = current_setting('app.current_user_id', true));
```

### Admin Access

```sql
-- Admins can access all data
CREATE POLICY {table}_admin_access ON {table}
    FOR ALL
    TO wtfb_user
    USING (current_setting('app.current_role', true) = 'admin');
```

### System Access

```sql
-- System operations bypass user checks
CREATE POLICY {table}_system_access ON {table}
    FOR ALL
    TO wtfb_user
    USING (current_setting('app.current_role', true) = 'system');
```

### Read-Only Public Access

```sql
-- Public can read, only owner can modify
CREATE POLICY {table}_public_read ON {table}
    FOR SELECT
    TO wtfb_user
    USING (true);  -- Anyone can read

CREATE POLICY {table}_owner_write ON {table}
    FOR INSERT, UPDATE, DELETE
    TO wtfb_user
    USING (user_id = current_setting('app.current_user_id', true));
```

## Customization Guide

1. **Replace placeholders**:
   - `{table}` → Your table name
   - `user_preferences` → Your actual table
   - Update Prisma model name

2. **Adjust RLS policies**:
   - Standard: User isolation only
   - +Admin: Add admin access policy
   - +System: Add system access policy
   - Public: Add public read policy

3. **Add indexes**:
   - Always index `user_id` for RLS performance
   - Add other indexes as needed

4. **Foreign keys**:
   - Reference `user.user_id` for user data
   - Add ON DELETE CASCADE for cleanup

## Security Checklist

- [x] **RLS Enabled**: `ENABLE ROW LEVEL SECURITY` + `FORCE ROW LEVEL SECURITY`
- [x] **Policies Created**: At least one policy per table
- [x] **Index Added**: `user_id` indexed for performance
- [x] **Foreign Key**: References `user.user_id` with CASCADE
- [x] **Documentation Updated**: DATA_DICTIONARY.md has table info
- [x] **ARCHitect Approval**: Schema changes approved

## Validation Commands

```bash
# Run migration
npx prisma migrate dev --name {migration_name}

# Verify RLS enabled
psql -U wtfb_user -d wtfb_dev \
  -c "SELECT tablename, rowsecurity FROM pg_tables WHERE tablename = '{table}';"

# Check policies exist
psql -U wtfb_user -d wtfb_dev \
  -c "\d+ {table}"

# Test user isolation
psql -U wtfb_app_user -d wtfb_dev \
  -c "SET app.current_user_id = 'test_user'; SELECT * FROM {table};"
```

## Example: Payments Table with RLS

```sql
-- Create payments table with RLS
CREATE TABLE "payments" (
    "id" SERIAL PRIMARY KEY,
    "user_id" VARCHAR(255) NOT NULL,
    "stripe_payment_id" VARCHAR(255) UNIQUE NOT NULL,
    "amount" INTEGER NOT NULL,
    "currency" VARCHAR(3) NOT NULL DEFAULT 'usd',
    "status" VARCHAR(50) NOT NULL,
    "created_at" TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY ("user_id") REFERENCES "user"("user_id") ON DELETE CASCADE
);

CREATE INDEX "payments_user_id_idx" ON "payments"("user_id");

ALTER TABLE "payments" ENABLE ROW LEVEL SECURITY;
ALTER TABLE "payments" FORCE ROW LEVEL SECURITY;

-- User can only see their own payments
CREATE POLICY payments_isolation ON "payments"
    FOR ALL
    TO wtfb_user
    USING (user_id = current_setting('app.current_user_id', true));

-- Admins can see all payments
CREATE POLICY payments_admin_access ON "payments"
    FOR ALL
    TO wtfb_user
    USING (current_setting('app.current_role', true) = 'admin');
```

## Related Patterns

- [Prisma Transaction](./prisma-transaction.md) - Complex operations
- [User Context API](../api/user-context-api.md) - Using RLS in APIs
- [Admin Context API](../api/admin-context-api.md) - Admin operations

---

**Pattern Source**: `docs/database/RLS_DATABASE_MIGRATION_SOP.md`
**Last Updated**: 2025-10-03
**Validated By**: System Architect
